{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-5 pt-3"> {# Use container-fluid for wider content #}
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title mb-0">View & Export Attendance Records</h2>
        </div>
        <div class="card-body">
            <!-- Form to Select Date for Viewing -->
            <form method="POST" action="{{ url_for('view_attendance') }}" class="row gx-3 gy-2 align-items-center mb-3 pb-3 border-bottom" style="border-color: rgba(255,255,255,0.2) !important;">
                <div class="col-sm-4">
                    <label for="attendance_date" class="form-label">Select Date to View:</label>
                    <input type="date" class="form-control" id="attendance_date" name="attendance_date" value="{{ selected_date }}">
                </div>
                <div class="col-sm-auto align-self-end">
                    <button type="submit" class="btn btn-primary w-100">View Records</button>
                </div>
            </form>

            <!-- Form for Exporting to Excel -->
            <form method="POST" action="{{ url_for('export_attendance') }}" class="row gx-3 gy-2 align-items-center">
                <div class="col-12"><h5 class="mb-2 mt-2 opacity-75">Export Range:</h5></div> {# Removed text-light #}
                <div class="col-sm-4">
                    <label for="start_date" class="form-label">Start Date:</label>
                    <input type="date" id="start_date" name="start_date" class="form-control" required value="{{ selected_date }}">
                </div>
                <div class="col-sm-4">
                    <label for="end_date" class="form-label">End Date:</label>
                    <input type="date" id="end_date" name="end_date" class="form-control" required value="{{ selected_date }}">
                </div>
                <div class="col-sm-auto align-self-end">
                    <button type="submit" class="btn btn-success w-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel-fill me-1" viewBox="0 0 16 16">
                            <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0M9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1M5.884 6.68 8 9.219l2.116-2.54a.5.5 0 1 1 .768.641L8.651 10l2.233 2.68a.5.5 0 0 1-.768.64L8 10.781l-2.116 2.54a.5.5 0 0 1-.768-.641L7.349 10 5.116 7.32a.5.5 0 1 1 .768-.64"/>
                        </svg> Export
                    </button>
                </div>
            </form>
        </div>
    </div>


    <div class="card">
        <div class="card-header">
            <h4 class="card-title mb-0">Records for: {{ selected_date }} (Times in IST)</h4>
        </div>
        <div class="card-body p-0"> {# Remove padding for table to fit edges #}
            {% if records_with_employee_info %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0"> {# mb-0 to remove bottom margin inside card #}
                    <thead>
                        <tr>
                            <th>Employee ID</th>
                            <th>Name</th>
                            <th>Designation</th>
                            <th>Date (IST)</th>
                            <th>Time In (IST)</th>
                            <th>Time Out (IST)</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record, emp_name, emp_id, emp_designation in records_with_employee_info %}
                        <tr>
                            <td>{{ emp_id }}</td>
                            <td>{{ emp_name }}</td>
                            <td>{{ emp_designation if emp_designation else 'N/A' }}</td>
                            <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                            {# --- IST Change: Use convert_utc_to_ist for display --- #}
                            <td>
                                {% if record.timestamp_in %}
                                    {{ convert_utc_to_ist(record.timestamp_in).strftime('%I:%M:%S %p') }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if record.timestamp_out %}
                                    {{ convert_utc_to_ist(record.timestamp_out).strftime('%I:%M:%S %p') }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge fs-6 rounded-pill
                                    {% if record.status == 'Clocked In' %} bg-success text-white
                                    {% elif record.status == 'Clocked Out' %} bg-secondary text-white
                                    {% elif record.status == 'Present' %} bg-primary text-white
                                    {% elif record.status == 'Absent' %} bg-danger text-white
                                    {% elif record.status == 'Late' %} bg-warning text-dark 
                                    {% elif record.status == 'On Leave' %} bg-info text-dark
                                    {% else %} bg-dark text-white
                                    {% endif %}">
                                    {{ record.status }}
                                </span>
                            </td>
                            <td>
                                <a href="{{ url_for('edit_attendance', att_id=record.id) }}" class="btn btn-sm btn-outline-primary" title="Edit Record">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-pencil-fill me-1" viewBox="0 0 16 16">
                                        <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/>
                                    </svg> Edit
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info m-3" role="alert"> {# Add margin if no records #}
                No attendance records found for {{ selected_date }}.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
